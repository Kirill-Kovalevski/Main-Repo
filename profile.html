<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LooZ ×¤×¨×•×¤×™×œ</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Rubik:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --wrap:24.375rem; --space:14px; --radius:16px;
      --bg0:#eef3ff; --bg1:#f9fbff;
      --fg:#0f172a; --muted:#475569;
      --card:#fff; --border:#e6ecf4; --chip:#f8fafc; --chip-b:#e5e7eb;
      --acc1:#7c3aed; --acc2:#22d3ee; --gold:#e8c65c;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    body.is-dark{
      --bg0:#0b1120; --bg1:#0d1730;
      --fg:#eaf2ff; --muted:#a3b1c6;
      --card:#15233b; --border:#2a3a5a; --chip:#0f1b32; --chip-b:#334867;
      --acc1:#9b8cff; --acc2:#22d3ee; --gold:#ffd86a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Rubik',system-ui,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg0));color:var(--fg)}
    .p{min-height:100dvh;max-width:var(--wrap);margin:auto;display:flex;flex-direction:column;gap:var(--space);
       padding:calc(env(safe-area-inset-top)+12px) 12px calc(env(safe-area-inset-bottom)+12px)}

    /* header row */
    .hdr{display:grid;grid-template-columns:auto 1fr auto;align-items:center}
    .hdr__btn{inline-size:2.4rem;block-size:2.4rem;border-radius:.8rem;border:1px solid var(--border);background:var(--chip);display:grid;place-items:center;cursor:pointer}
    .title{margin:0;text-align:center;font-family:'Cormorant Garamond',serif;font-weight:600;letter-spacing:.02em}
    .title b{background:linear-gradient(90deg,#5e4e2e,#c79a29,#e9d8a6,#5e4e2e);-webkit-background-clip:text;background-clip:text;color:transparent}

    /* cards */
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:var(--space)}
    .glow{box-shadow:0 14px 32px rgba(124,58,237,.10)}

    /* hero */
    .hero{position:relative; padding-top:86px; text-align:center;
      background:radial-gradient(160% 130% at 50% -25%, #fff7df, #fff); border-color:rgba(197,154,33,.25)}
    body.is-dark .hero{background:linear-gradient(180deg,#0f1b32,#10203a)}
    .avatar-wrap{position:absolute; inset-inline:0; top:-56px; display:grid; place-items:center}
    .avatar{inline-size:120px; block-size:120px; border-radius:50%; background:#ffe38a center/cover no-repeat;
            border:5px solid var(--card); box-shadow:0 12px 28px rgba(199,154,41,.22); cursor:pointer}
    .name{margin:.35rem 0 0; font-size:1.18rem; font-weight:800}
    .status{margin:.1rem 0 0; color:var(--muted)}
    .row{display:flex; gap:.4rem; justify-content:center; margin-top:.5rem; flex-wrap:wrap}
    .pill{border:1px solid var(--border); background:var(--chip); border-radius:999px; padding:.25rem .65rem; font-weight:700}
    .btn{border:0;border-radius:999px;padding:.4rem .8rem;cursor:pointer}
    .btn--like{background:linear-gradient(90deg,#f43f5e,#fb7185);color:#fff}
    .btn--sub{background:linear-gradient(90deg,var(--acc1),var(--acc2));color:#fff}
    .btn--ghost{background:var(--chip);border:1px solid var(--border)}

    /* metrics */
    .two{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
    .metric{display:grid;gap:2px;place-items:center;background:var(--chip);border:1px solid var(--border);border-radius:12px;padding:.6rem .3rem}
    .metric__n{font-weight:900}
    .metric__l{font-size:.85rem;color:var(--muted)}

    /* task summary */
    .tri{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
    .box{display:grid;gap:2px;place-items:center;background:linear-gradient(180deg,#ffffff,var(--chip));border:1px solid var(--border);border-radius:12px;padding:.6rem .3rem;cursor:pointer}
    .box__n{font-weight:900}
    .box__l{font-size:.85rem;color:var(--muted)}

    /* stats */
    .stats{display:grid;gap:.6rem}
    .statrow{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:.5rem}
    .statrow__title{margin:0;font-weight:900}
    .tiny{width:100%;height:36px;display:block}
    .tag{padding:.18rem .5rem;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-size:.8rem}

    /* streak */
    .streak__row{display:flex;gap:.3rem;justify-content:center;flex-wrap:wrap}
    .v{font-weight:900;color:#cbd5e1}
    .v--gold{color:var(--gold); text-shadow:0 0 10px rgba(232,198,92,.45)}

    /* modal list */
    .ov{position:fixed;inset:0;background:rgba(15,23,42,.35);backdrop-filter:blur(2px);display:none;align-items:flex-end;justify-content:center;z-index:60}
    .ov.is-on{display:flex}
    .panel{width:100%;max-width:var(--wrap);max-height:70dvh;overflow:auto;border-radius:16px 16px 0 0;background:var(--card);border:1px solid var(--border);padding:12px}
    .list{list-style:none;margin:0;padding:0;display:grid;gap:.5rem}
    .li{display:grid;grid-template-columns:auto 1fr auto;gap:.6rem;align-items:center;border:1px solid var(--border);border-radius:12px;padding:.55rem}
    .li__t{font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .li__m{font-size:.85rem;color:var(--muted)}
  </style>
</head>
<body>
  <main class="p">
    <!-- header -->
    <div class="hdr">
      <button id="btnEdit" class="hdr__btn" title="×¢×¨×™×›×”">âœ</button>
      <h1 class="title"><b>LooZ</b> ×¤×¨×•×¤×™×œ</h1>
      <button id="btnDark" class="hdr__btn" title="××¦×‘ ×›×”×”">ğŸŒ™</button>
    </div>

    <!-- hero -->
    <section class="card hero glow">
      <div class="avatar-wrap">
        <div id="avatar" class="avatar" title="×”×¢×œ×” ×ª××•× ×”"></div>
        <input id="avatarFile" type="file" accept="image/*" style="display:none" />
      </div>
      <h2 id="name" class="name">â€”</h2>
      <p id="status" class="status">×ª×™××•×¨ ×§×¦×¨/×¡×˜×˜×•×¡ ×›××Ÿ</p>
      <div class="row">
        <button id="btnLike" class="btn btn--like">â¤ï¸ ×œ×™×™×§</button>
        <span class="pill">×œ×™×™×§×™×: <b id="likesNum">0</b></span>
        <button id="btnSub" class="btn btn--sub">×”×™×¨×©×</button>
      </div>
    </section>

    <!-- followers / following -->
    <section class="card glow">
      <div class="two">
        <div class="metric"><div class="metric__n" id="followersNum">0</div><div class="metric__l">×¢×•×§×‘×™×</div></div>
        <div class="metric"><div class="metric__n" id="followingNum">0</div><div class="metric__l">× ×¢×§×‘×™×</div></div>
      </div>
    </section>

    <!-- task summary -->
    <section class="card glow">
      <div class="tri">
        <button class="box" id="btnDone"><div class="box__n" id="sumDone">0</div><div class="box__l">×”×•×©×œ××•</div></button>
        <button class="box" id="btnRemoved"><div class="box__n" id="sumRemoved">0</div><div class="box__l">× ××—×§×•</div></button>
        <button class="box" id="btnOpen"><div class="box__n" id="sumOpen">0</div><div class="box__l">×¤×ª×•×—×•×ª</div></button>
      </div>
    </section>

    <!-- stats -->
    <section class="card glow">
      <div class="stats">
        <div class="statrow">
          <h3 class="statrow__title">×”×™×•×</h3>
          <svg id="chartDay" class="tiny" viewBox="0 0 120 36" preserveAspectRatio="none"></svg>
          <span id="pillDay" class="tag">0/0</span>
        </div>
        <div class="statrow">
          <h3 class="statrow__title">×”×©×‘×•×¢</h3>
          <svg id="chartWeek" class="tiny" viewBox="0 0 120 36" preserveAspectRatio="none"></svg>
          <span id="pillWeek" class="tag">0%</span>
        </div>
        <div class="statrow">
          <h3 class="statrow__title">×”×—×•×“×©</h3>
          <svg id="chartMonth" class="tiny" viewBox="0 0 120 36" preserveAspectRatio="none"></svg>
          <span id="pillMonth" class="tag">0%</span>
        </div>
      </div>
    </section>

    <!-- streak -->
    <section class="card glow">
      <h3 style="margin:0 0 .4rem;font-weight:900">×¨×¦×£ ×™××™× ×©×”×•×©×œ××•</h3>
      <div id="streakRow" class="streak__row"></div>
    </section>
  </main>

  <!-- modal list -->
  <div id="modal" class="ov" aria-hidden="true">
    <div class="panel">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.4rem">
        <h3 id="modalTitle" style="margin:0;font-weight:900"></h3>
        <button id="modalClose" class="btn btn--ghost">×¡×’×•×¨</button>
      </div>
      <ul id="modalList" class="list"></ul>
    </div>
  </div>

  <script>
  (function(){
    // ---- keys ----
    const K = {
      PROFILE: 'profile.meta', AVATAR:'profile.avatar', DARK:'profile.dark',
      LIKES:'profile.likes', FOLLOWERS:'profile.followers', FOLLOWING:'profile.following',
      STATS:'loozStats', // {doneTotal, removedTotal}
      TASKS: ['plannerTasks','events','loozEvents']
    };

    // ---- profile state ----
    const meta = read(K.PROFILE, {name:'×“× ×™××œ×”', status:'×ª×™××•×¨ ×§×¦×¨/×¡×˜×˜×•×¡ ×›××Ÿ'});
    const likes = +read(K.LIKES, 0);
    const followers = read(K.FOLLOWERS, []); // array of ids/names
    const following = read(K.FOLLOWING, []);
    const agg = read(K.STATS, {doneTotal:0, removedTotal:0}); // updated by app.js patch
    if (read(K.DARK,false)) document.body.classList.add('is-dark');

    // ---- DOM ----
    const nameEl = document.getElementById('name');
    const statusEl = document.getElementById('status');
    const likesEl = document.getElementById('likesNum');
    const follEl = document.getElementById('followersNum');
    const wingEl = document.getElementById('followingNum');
    nameEl.textContent = meta.name; statusEl.textContent = meta.status; likesEl.textContent = likes;
    follEl.textContent = followers.length; wingEl.textContent = following.length;

    const savedAvatar = localStorage.getItem(K.AVATAR); if (savedAvatar) setAvatar(savedAvatar);

    // ---- tasks ----
    const tasks = readTasks();
    // open = current items; done/removed = stored aggregates
    paintCounts();
    chartsAndStreak();

    // ---- buttons ----
    document.getElementById('btnDark').onclick = () => {
      document.body.classList.toggle('is-dark');
      write(K.DARK, document.body.classList.contains('is-dark'));
    };
    document.getElementById('btnEdit').onclick = () => {
      const n = prompt('×©× ×œ×”×¦×’×”:', nameEl.textContent.trim());
      if (n!==null && n.trim()){ meta.name=n.trim(); write(K.PROFILE, meta); nameEl.textContent=meta.name; }
      const s = prompt('×¡×˜×˜×•×¡/×ª×™××•×¨:', statusEl.textContent.trim());
      if (s!==null){ meta.status=s.trim(); write(K.PROFILE, meta); statusEl.textContent=meta.status; }
    };
    document.getElementById('btnLike').onclick = () => {
      const v = (+localStorage.getItem(K.LIKES)||0) + 1;
      localStorage.setItem(K.LIKES, v); likesEl.textContent = v;
    };
    // subscribe (toggle following-this-profile from this browser)
    document.getElementById('btnSub').onclick = () => {
      // Demo: pretend current viewer is "localUser"
      const me = read('authName', 'localUser');
      const arr = read(K.FOLLOWERS, []);
      const i = arr.indexOf(me);
      if (i === -1) arr.push(me); else arr.splice(i,1);
      write(K.FOLLOWERS, arr);
      document.getElementById('followersNum').textContent = arr.length;
      // Visual toggle text
      document.getElementById('btnSub').textContent = (i===-1) ? '×× ×•×™ âœ“' : '×”×™×¨×©×';
    };

    // avatar upload
    const a = document.getElementById('avatar'), f = document.getElementById('avatarFile');
    a.onclick = ()=> f.click();
    f.onchange = () => { const file = f.files && f.files[0]; if(!file) return; const r=new FileReader(); r.onload=e=>{ setAvatar(e.target.result); localStorage.setItem(K.AVATAR, e.target.result);}; r.readAsDataURL(file); };

    // task modal actions
    document.getElementById('btnOpen').onclick    = ()=> openList('×¤×ª×•×—×•×ª',      tasks.filter(t=>!t.removed && !t.done));
    document.getElementById('btnDone').onclick    = ()=> openList('×”×•×©×œ××• (××¦×˜×‘×¨)', makeFakeList('×”×•×©×œ××”', agg.doneTotal));
    document.getElementById('btnRemoved').onclick = ()=> openList('× ××—×§×• (××¦×˜×‘×¨)', makeFakeList('× ××—×§×”', agg.removedTotal));

    document.getElementById('modalClose').onclick = closeModal;
    document.getElementById('modal').addEventListener('click', e=>{ if (e.target.id==='modal') closeModal(); });

    // ---- helpers ----
    function read(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback }catch{ return fallback } }
    function write(key,val){ localStorage.setItem(key, JSON.stringify(val)); }
    function setAvatar(dataUrl){ document.getElementById('avatar').style.backgroundImage = `url("${dataUrl}")`; }

    function readTasks(){
      for (const k of K.TASKS){
        const raw = localStorage.getItem(k); if (!raw) continue;
        try{
          const arr = JSON.parse(raw)||[]; if (!Array.isArray(arr)) continue;
          // normalize
          return arr.map(t=>({ title:t.title||t.name||'×œ×œ× ×›×•×ª×¨×ª', date:t.date||t.day||t.d||'', time:t.time||t.t||'', done:!!t.done, removed:!!t.removed }));
        }catch{}
      }
      return [];
    }

    function paintCounts(){
      const open = tasks.filter(t=>!t.removed && !t.done).length;
      document.getElementById('sumOpen').textContent = open;
      document.getElementById('sumDone').textContent = agg.doneTotal || 0;
      document.getElementById('sumRemoved').textContent = agg.removedTotal || 0;
    }

    function chartsAndStreak(){
      const today = new Date().toISOString().slice(0,10);
      const day = countFor(today);
      paintBars(document.getElementById('chartDay'), [day.done, Math.max(0,day.total-day.done)], ['#10b981','#e5e7eb']);
      document.getElementById('pillDay').textContent = `${day.done}/${day.total}`;

      const week = backRange(today,6);
      const wp = week.map(d=> ratio(countFor(d)));
      paintSpark(document.getElementById('chartWeek'), wp, '#7c3aed');
      document.getElementById('pillWeek').textContent = Math.round(avg(wp))+'%';

      const month = backRange(today,29);
      const mp = month.map(d=> ratio(countFor(d)));
      paintSpark(document.getElementById('chartMonth'), mp, '#22d3ee');
      document.getElementById('pillMonth').textContent = Math.round(avg(mp))+'%';

      // streak (gold V if all tasks for that day are done AND total>0)
      const host = document.getElementById('streakRow'); host.innerHTML='';
      const days = 14;
      for (let i=0;i<days;i++){
        const d = shift(today,-i); const c = countFor(d);
        const ok = c.total>0 && c.done===c.total;
        const s = document.createElement('span'); s.className='v'+(ok?' v--gold':''); s.textContent='V'; s.title=`${d} Â· ${c.done}/${c.total}`;
        host.appendChild(s);
      }
    }

    function countFor(iso){
      const list = tasks.filter(t=>t.date===iso && !t.removed);
      return {total:list.length, done:list.filter(t=>t.done).length};
    }
    function shift(iso,delta){ const d=new Date(iso); d.setDate(d.getDate()+delta); return d.toISOString().slice(0,10); }
    function backRange(endISO,n){ const a=[]; for(let i=n;i>=0;i--) a.push(shift(endISO,-i)); return a; }
    const ratio = x => x.total?Math.round(100*x.done/x.total):0;
    const avg = a => a.length? a.reduce((s,x)=>s+x,0)/a.length : 0;

    // charts
    function rect(x,y,w,h,rx,fill){const el=document.createElementNS('http://www.w3.org/2000/svg','rect');el.setAttribute('x',x);el.setAttribute('y',y);el.setAttribute('width',Math.max(0,w));el.setAttribute('height',h);el.setAttribute('rx',rx);el.setAttribute('fill',fill);return el;}
    function outline(svg){const o=document.createElementNS('http://www.w3.org/2000/svg','rect');o.setAttribute('x',.5);o.setAttribute('y',.5);o.setAttribute('width',119);o.setAttribute('height',35);o.setAttribute('rx',6);o.setAttribute('fill','none');o.setAttribute('stroke','var(--border)');svg.appendChild(o);}
    function paintBars(svg, values, colors){const tot=Math.max(1,values.reduce((s,x)=>s+x,0)); let x=0; svg.innerHTML=''; values.forEach((v,i)=>{const w=120*(v/tot); svg.appendChild(rect(x,6,w,24,6,colors[i]||'#999')); x+=w;}); outline(svg);}
    function paintSpark(svg, arr, color){svg.innerHTML=''; const n=arr.length,g=2,bw=(120-(n-1)*g)/n; arr.forEach((v,i)=>{const h=(v/100)*30; const r=rect(i*(bw+g),36-h,bw,h,3,color); r.setAttribute('opacity',String(0.35+0.65*(v/100))); svg.appendChild(r);}); outline(svg);}

    // modal list
    function openList(title, list){
      document.getElementById('modalTitle').textContent = title;
      const ul = document.getElementById('modalList'); ul.innerHTML='';
      if (!list.length){ const li=document.createElement('li'); li.className='li'; li.textContent='××™×Ÿ × ×ª×•× ×™×'; ul.appendChild(li); }
      list.sort((a,b)=>(a.date||'').localeCompare(b.date||'')||(a.time||'').localeCompare(b.time||''));
      list.forEach(x=>{ const li=document.createElement('li'); li.className='li';
        li.innerHTML = `<span class="li__m">${x.time||''}</span><span class="li__t">${escape(String(x.title||''))}</span><span class="li__m">${x.date||''}</span>`;
        ul.appendChild(li);
      });
      document.getElementById('modal').classList.add('is-on');
      document.getElementById('modal').setAttribute('aria-hidden','false');
    }
    function closeModal(){ const m=document.getElementById('modal'); m.classList.remove('is-on'); m.setAttribute('aria-hidden','true'); }
    function escape(s){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  })();
  </script>
</body>
</html>
